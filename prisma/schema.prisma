generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String            @id
  email                 String            @unique
  username              String?           @unique
  firstName             String?
  lastName              String?
  imageUrl              String?
  trustScore            Int               @default(100)
  trustHistory          String?
  phoneNumber           String?
  voiceRemindersEnabled Boolean           @default(false)
  isSearchable          Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  disputeMessages       DisputeMessage[]
  loansTaken            Loan[]            @relation("Borrower")
  loansGiven            Loan[]            @relation("Lender")
  loanTemplates         LoanTemplate[]
  repaymentsReceived    Repayment[]       @relation("Receiver")
  repaymentsGiven       Repayment[]       @relation("Payer")
  userIntegrations      UserIntegration[]
}

model Loan {
  id             String          @id @default(uuid())
  lenderId       String
  borrowerId     String
  amount         Float
  balance        Float
  currency       String          @default("USD")
  purpose        String?
  notes          String?
  dueDate        DateTime
  status         String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  completedAt    DateTime?
  disputeThread  DisputeThread?
  emailReminders EmailReminder[]
  borrower       User            @relation("Borrower", fields: [borrowerId], references: [id])
  lender         User            @relation("Lender", fields: [lenderId], references: [id])
  repayments     Repayment[]
  voiceReminders VoiceReminder[]

  @@index([lenderId])
  @@index([borrowerId])
  @@index([status])
}

model Repayment {
  id          String    @id @default(uuid())
  loanId      String
  payerId     String
  receiverId  String
  amount      Float
  note        String?
  status      String
  initiatedBy String
  confirmedBy String?
  confirmedAt DateTime?
  createdAt   DateTime  @default(now())
  receiver    User      @relation("Receiver", fields: [receiverId], references: [id])
  payer       User      @relation("Payer", fields: [payerId], references: [id])
  loan        Loan      @relation(fields: [loanId], references: [id])

  @@index([loanId])
}

model UserIntegration {
  id           String   @id @default(uuid())
  userId       String
  provider     String
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, provider])
}

model EmailReminder {
  id           String    @id @default(uuid())
  loanId       String
  type         String
  sentAt       DateTime?
  scheduledFor DateTime
  status       String
  createdAt    DateTime  @default(now())
  loan         Loan      @relation(fields: [loanId], references: [id])

  @@index([scheduledFor, status])
}

model VoiceReminder {
  id           String    @id @default(uuid())
  loanId       String
  phoneNumber  String
  callId       String?
  status       String
  duration     Int?
  transcript   String?
  scheduledFor DateTime
  calledAt     DateTime?
  createdAt    DateTime  @default(now())
  loan         Loan      @relation(fields: [loanId], references: [id])

  @@index([scheduledFor, status])
}

model LoanTemplate {
  id           String   @id @default(uuid())
  userId       String
  name         String
  amount       Float
  purpose      String
  daysUntilDue Int
  isDefault    Boolean  @default(false)
  useCount     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model SystemTemplate {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String
  amount       Float
  purpose      String
  daysUntilDue Int
  icon         String
  category     String
  createdAt    DateTime @default(now())
}

model DisputeThread {
  id         String           @id @default(uuid())
  loanId     String           @unique
  status     String
  resolution String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  resolvedAt DateTime?
  messages   DisputeMessage[]
  loan       Loan             @relation(fields: [loanId], references: [id])
}

model DisputeMessage {
  id            String        @id @default(uuid())
  threadId      String
  senderId      String
  content       String
  attachments   String?
  isAiGenerated Boolean       @default(false)
  aiSuggestion  String?
  createdAt     DateTime      @default(now())
  sender        User          @relation(fields: [senderId], references: [id])
  thread        DisputeThread @relation(fields: [threadId], references: [id])

  @@index([threadId])
}
